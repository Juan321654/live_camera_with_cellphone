<!DOCTYPE html>
<html>
<style>
     img {
          width: 50%;
     }

     #rotate-button {
          display: block;
          margin: 10px auto;
          padding: 1rem 2rem;
          font-size: 1.5rem;
     }
</style>

<head>
     <title>Surveillance Camera</title>
     <script src="/socket.io/socket.io.js"></script>
     <script>
          document.addEventListener('DOMContentLoaded', function () {
               const socket = io();
               let rotationDegrees = 0; // Initialize rotation degrees

               // Function to get the rear camera stream
               function getRearCameraStream() {
                    return navigator.mediaDevices.enumerateDevices()
                         .then(devices => {
                              const rearCamera = devices.find(device => device.kind === 'videoinput' && device.label.toLowerCase().includes('back'));
                              const constraints = {
                                   video: {
                                        width: { ideal: 320 },  // Lower resolution - adjust as needed
                                        height: { ideal: 240 }, // Lower resolution - adjust as needed
                                   },
                              };
                              if (rearCamera) {
                                   constraints.video.deviceId = { exact: rearCamera.deviceId };
                              }
                              return navigator.mediaDevices.getUserMedia(constraints);
                         });
               }

               // Function to capture the video frame and emit it to the server
               function captureAndSend() {
                    const video = document.querySelector('video');
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');

                    // Rotate the canvas before drawing the video frame
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate((rotationDegrees * Math.PI) / 180); // Convert degrees to radians
                    ctx.drawImage(video, -canvas.width / 2, -canvas.height / 2);
                    ctx.restore();

                    const data = canvas.toDataURL('image/png');
                    socket.emit('stream', data);
               }

               getRearCameraStream()
                    .then(stream => {
                         const video = document.querySelector('video');
                         video.srcObject = stream;
                         video.play();

                         // Capture and send the frame every 100ms (adjust as needed)
                         setInterval(captureAndSend, 100);
                    })
                    .catch(err => {
                         console.error('Error accessing camera:', err);
                    });

               socket.on('stream', (image) => {
                    // Assuming you have an img element with id 'stream'
                    const streamImage = document.getElementById('stream');
                    streamImage.src = image;
               });

               // Add a button click event handler to rotate the screen
               const rotateButton = document.getElementById('rotate-button');
               rotateButton.addEventListener('click', () => {
                    rotationDegrees += 90; // Rotate by 90 degrees
                    if (rotationDegrees >= 360) {
                         rotationDegrees = 0; // Reset to 0 degrees after 360 degrees
                    }
               });
          });
     </script>
</head>

<body>
     <video style="display:none;" autoplay></video> <!-- Hidden video element for capturing the stream -->
     <img id="stream" alt="Streaming video"> <!-- Display incoming stream here -->
     <button id="rotate-button">Rotate 90 Degrees</button> <!-- Button to rotate the screen -->
</body>

</html>